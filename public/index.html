<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FiatLux - –ì—Ä–∞—Ñ—ñ–∫ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å–≤—ñ—Ç–ª–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 15px;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .current-time {
            font-size: 1em;
            opacity: 0.9;
            margin-bottom: 3px;
        }

        .api-status {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .api-status.connected {
            color: #86efac;
        }

        .api-status.disconnected {
            color: #fca5a5;
        }

        .api-status.no-data {
            color: #9ca3af;
        }

        .status-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0;
        }

        .status-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .status-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
        }

        .power-on {
            background: #86efac;
            animation: pulse-green 2s infinite;
        }

        .power-off {
            background: #fca5a5;
            animation: pulse-red 2s infinite;
        }

        .power-unknown {
            background: #e5e7eb;
            animation: none;
        }

        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(134, 239, 172, 0.7); }
            50% { box-shadow: 0 0 0 15px rgba(134, 239, 172, 0); }
        }

        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(252, 165, 165, 0.7); }
            50% { box-shadow: 0 0 0 15px rgba(252, 165, 165, 0); }
        }

        .countdown {
            text-align: right;
        }

        .countdown-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 3px;
        }

        .countdown-time {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }

        .timeline {
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 10px;
        }

        .timeline-header {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .timeline-subheader {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 10px;
        }

        .timeline-container {
            position: relative;
            height: 50px;
            background: #d1fae5;
            border-radius: 8px;
            overflow: visible;
        }

        .timeline-scroll {
            position: relative;
            height: 100%;
            width: 100%;
        }

        .timeline-hours {
            display: flex;
            height: 100%;
            position: relative;
            width: 100%;
        }

        .timeline-segment {
            flex: 1;
            position: relative;
            border-right: 1px solid rgba(6, 78, 59, 0.1);
        }

        .timeline-segment.hour {
            border-right: 2px solid rgba(6, 78, 59, 0.15);
        }

        .timeline-segment.past {
            opacity: 0.9;
        }

        .timeline-segment.current-hour {
            background: rgba(167, 139, 250, 0.15);
        }

        .timeline-labels {
            display: flex;
            width: 100%;
            margin-top: 3px;
            position: relative;
            height: 30px;
        }

        .timeline-label {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.75em;
            color: #666;
            transform: translateX(-50%);
        }

        .timeline-label.show {
            display: flex;
        }

        .timeline-label.hide {
            display: none;
        }

        .label-time {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .label-date {
            font-size: 0.85em;
            color: #999;
            margin-top: 2px;
        }

        #noDataPeriods {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        #powerOnPeriods {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        #powerOffPeriods {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 3;
        }

        .no-data-period {
            position: absolute;
            top: 0;
            height: 100%;
            background: #e5e7eb;
            opacity: 0.9;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .power-off-period {
            position: absolute;
            top: 0;
            height: 100%;
            background: linear-gradient(135deg, #fca5a5 0%, #f87171 100%);
            opacity: 0.95;
            transition: all 0.3s ease;
            pointer-events: auto;
            cursor: pointer;
            border-radius: 5px;
        }

        .power-off-period.past {
            opacity: 0.4;
        }

        .power-off-period:hover {
            opacity: 1;
            z-index: 100;
            transform: scale(1.05) translateY(-3px);
            box-shadow: 0 8px 20px rgba(248, 113, 113, 0.6);
            filter: brightness(1.1);
        }

        .power-on-period {
            position: absolute;
            top: 0;
            height: 100%;
            background: transparent;
            opacity: 1;
            transition: all 0.3s ease;
            pointer-events: auto;
            cursor: pointer;
            border-radius: 5px;
        }

        .power-on-period:hover {
            background: rgba(16, 185, 129, 0.35);
            z-index: 50;
            transform: scale(1.05) translateY(-3px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.5);
        }

        .timeline-tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            pointer-events: none;
            z-index: 10000;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transform: translateY(-100%);
            margin-top: -8px;
        }

        .timeline-tooltip.show {
            opacity: 1;
        }

        .timeline-tooltip-time {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .timeline-tooltip-duration {
            font-size: 0.9em;
            color: #d1d5db;
        }

        .current-time-marker {
            position: absolute;
            top: 0;
            width: 3px;
            height: 100%;
            background: #8b5cf6;
            z-index: 10;
            animation: blink 1s infinite;
            pointer-events: none;
        }

        .current-time-marker::before {
            content: '–ó–ê–†–ê–ó';
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: #8b5cf6;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            white-space: nowrap;
        }

        .current-time-marker::after {
            content: '';
            position: absolute;
            top: -5px;
            left: -4px;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 8px solid #8b5cf6;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .schedule-list {
            margin-top: 10px;
        }

        .schedule-section {
            margin-bottom: 12px;
        }

        .schedule-section-title {
            font-weight: bold;
            color: #666;
            margin-bottom: 8px;
            font-size: 0.85em;
            text-transform: uppercase;
        }

        .schedule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .schedule-item.past {
            opacity: 0.6;
        }

        .schedule-item.active {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
        }

        .schedule-item:hover {
            background: #f3f4f6;
            transform: translateX(5px);
        }

        .schedule-item-left {
            flex: 1;
        }

        .schedule-queue {
            font-weight: bold;
            color: #333;
            margin-bottom: 3px;
        }

        .schedule-time {
            font-size: 0.85em;
            color: #666;
        }

        .schedule-status {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .schedule-status.off {
            background: #fee2e2;
            color: #dc2626;
        }

        .schedule-status.on {
            background: #dcfce7;
            color: #16a34a;
        }

        .schedule-status.no-data {
            background: #e5e7eb;
            color: #6b7280;
        }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .no-data {
            text-align: center;
            padding: 25px 15px;
            color: #666;
            font-size: 1em;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5em;
            }

            .status-indicator {
                flex-direction: column;
                gap: 15px;
            }

            .countdown {
                text-align: center;
            }

            .timeline-label {
                font-size: 0.65em;
            }

            .label-date {
                font-size: 0.8em;
            }
        }

        .loading {
            text-align: center;
            padding: 15px;
            color: #666;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        .queue-selector-card {
            background: white;
            border-radius: 15px;
            padding: 12px 15px;
            margin-bottom: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .queue-selector-label {
            font-weight: 600;
            color: #333;
            white-space: nowrap;
        }

        .queue-selector {
            flex: 1;
            max-width: 400px;
        }

        .queue-selector select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95em;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            color: #333;
        }

        .queue-selector select:hover {
            border-color: #8b5cf6;
        }

        .queue-selector select:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        @media (max-width: 768px) {
            .queue-selector-card {
                flex-direction: column;
                align-items: flex-start;
            }

            .queue-selector {
                width: 100%;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° FiatLux - –ì—Ä–∞—Ñ—ñ–∫ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å–≤—ñ—Ç–ª–∞</h1>
            <div class="current-time" id="currentTime"></div>
            <div class="api-status disconnected" id="apiStatus">–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞...</div>
        </div>

        <div id="errorContainer"></div>

        <div class="status-card">
            <div class="status-indicator">
                <div class="status-label">
                    <div class="status-icon" id="statusIcon">üí°</div>
                    <span id="statusText">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
                </div>
                <div class="countdown">
                    <div class="countdown-label" id="countdownLabel">–î–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è</div>
                    <div class="countdown-time" id="countdownTime">--:--:--</div>
                </div>
            </div>
        </div>

        <div class="queue-selector-card">
            <div class="queue-selector-label">–û–±—Ä–∞—Ç–∏ —á–µ—Ä–≥—É:</div>
            <div class="queue-selector">
                <select id="queueSelector">
                </select>
            </div>
        </div>

        <div class="timeline">
            <div class="timeline-header">üìÖ –ì—Ä–∞—Ñ—ñ–∫ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å</div>
            <div class="timeline-subheader" id="timelineSubheader">12 –≥–æ–¥–∏–Ω –Ω–∞–∑–∞–¥ ‚Üê –ó–ê–†–ê–ó ‚Üí 24 –≥–æ–¥–∏–Ω–∏ –≤–ø–µ—Ä–µ–¥</div>
            <div class="timeline-container" id="timelineContainer">
                <div class="timeline-hours" id="timelineHours"></div>
                <div id="noDataPeriods"></div>
                <div id="powerOnPeriods"></div>
                <div id="powerOffPeriods"></div>
                <div class="current-time-marker" id="timeMarker"></div>
            </div>
            <div class="timeline-labels" id="timelineLabels"></div>

            <div class="schedule-list" id="scheduleList"></div>
        </div>
    </div>

    <!-- Tooltip –∑–∞ –º–µ–∂–∞–º–∏ timeline –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è -->
    <div class="timeline-tooltip" id="timelineTooltip">
        <div class="timeline-tooltip-time" id="tooltipTime"></div>
        <div class="timeline-tooltip-duration" id="tooltipDuration"></div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const QUEUE_STORAGE_KEY = 'selectedQueue';
        let powerOffSchedule = [];
        let allQueues = [];
        let selectedQueue = '';
        
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ SESSION_STRING
        async function checkSetupRequired() {
            try {
                const response = await fetch(`${API_BASE}/api/setup/status`);
                const data = await response.json();
                
                if (data.success && !data.data.configured) {
                    // Redirect to setup page
                    window.location.href = '/setup.html';
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Failed to check setup status:', error);
                return false;
            }
        }
        
        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤–∏–±—Ä–∞–Ω—É —á–µ—Ä–≥—É –∑ localStorage
        function loadSavedQueue() {
            const saved = localStorage.getItem(QUEUE_STORAGE_KEY);
            if (saved) {
                selectedQueue = saved;
            }
        }
        
        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤–∏–±—Ä–∞–Ω—É —á–µ—Ä–≥—É –≤ localStorage
        function saveSelectedQueue(queue) {
            localStorage.setItem(QUEUE_STORAGE_KEY, queue);
        }
        let updateInterval = null;

        async function fetchScheduleData() {
            try {
                const response = await fetch(`${API_BASE}/api/schedule/all`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                updateApiStatus(true);

                if (!data.success || !data.data) {
                    throw new Error('–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ');
                }

                powerOffSchedule = [];
                const schedules = [];
                if (data.data.current) schedules.push(data.data.current);
                if (data.data.future) schedules.push(data.data.future);

                // –†–æ–∑–ø–∞–∫–æ–≤—É—î–º–æ —Ä–æ–∑–∫–ª–∞–¥–∏ –≤ –ø–µ—Ä—ñ–æ–¥ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å
                schedules.forEach(schedule => {
                    if (schedule.queues && Array.isArray(schedule.queues)) {
                        // –ü–∞—Ä—Å–∏–º–æ –¥–∞—Ç—É –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º—É —á–∞—Å–æ–≤–æ–º—É –ø–æ—è—Å—ñ
                        const [year, month, day] = schedule.date.split('-').map(Number);
                        const scheduleDate = new Date(year, month - 1, day);
                        
                        schedule.queues.forEach(queue => {
                            if (queue.timeSlots && Array.isArray(queue.timeSlots)) {
                                queue.timeSlots.forEach(slot => {
                                    const startDate = new Date(scheduleDate);
                                    const [startH, startM] = slot.start.split(':').map(Number);
                                    startDate.setHours(startH, startM, 0, 0);

                                    const endDate = new Date(scheduleDate);
                                    const [endH, endM] = slot.end.split(':').map(Number);
                                    endDate.setHours(endH, endM, 0, 0);

                                    // –Ø–∫—â–æ —á–∞—Å –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è –º–µ–Ω—à–∏–π –∑–∞ —á–∞—Å –ø–æ—á–∞—Ç–∫—É, —Ü–µ –Ω–∞—Å—Ç—É–ø–Ω–∞ –¥–æ–±–∞
                                    if (endDate <= startDate) {
                                        endDate.setDate(endDate.getDate() + 1);
                                    }

                                    powerOffSchedule.push({
                                        start: startDate,
                                        end: endDate,
                                        queue: queue.queueNumber,
                                        scheduleId: schedule.id
                                    });
                                });
                            }
                        });
                    }
                });

                // –°–æ—Ä—Ç—É—î–º–æ –∑–∞ —á–∞—Å–æ–º –ø–æ—á–∞—Ç–∫—É
                powerOffSchedule.sort((a, b) => a.start - b.start);

                // –í–∏–∑–Ω–∞—á–∞—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ —á–µ—Ä–≥–∏ —Ç–∞ –∑–∞–ø–æ–≤–Ω—é—î–º–æ selector
                allQueues = [...new Set(powerOffSchedule.map(p => p.queue))].sort((a, b) => a - b);
                populateQueueSelector();
                
                // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω—É —á–µ—Ä–≥—É –∞–±–æ –≤–∏–±–∏—Ä–∞—î–º–æ –ø–µ—Ä—à—É –¥–æ—Å—Ç—É–ø–Ω—É
                loadSavedQueue();
                if (!selectedQueue && allQueues.length > 0) {
                    selectedQueue = String(allQueues[0]);
                    saveSelectedQueue(selectedQueue);
                }
                document.getElementById('queueSelector').value = selectedQueue;
                
                // –î–æ–¥–∞—î–º–æ —Å–ª—É—Ö–∞—á –¥–ª—è –∑–º—ñ–Ω–∏ —á–µ—Ä–≥–∏
                document.getElementById('queueSelector').addEventListener('change', (e) => {
                    selectedQueue = e.target.value;
                    saveSelectedQueue(selectedQueue);
                    initializeTimeline();
                    initializeScheduleList();
                    updateStatus();
                    updateTimeMarker();
                });

                initializeTimeline();
                initializeScheduleList();
                updateCurrentTime();
                updateStatus();
                updateTimeMarker();

                // –û—á–∏—â—É—î–º–æ —Å—Ç–∞—Ä–∏–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª
                if (updateInterval) clearInterval(updateInterval);

                // –û–Ω–æ–≤–ª—é—î–º–æ –∫–æ–∂–Ω—É —Å–µ–∫—É–Ω–¥—É
                updateInterval = setInterval(() => {
                    updateCurrentTime();
                    updateStatus();
                    updateTimeMarker();
                }, 1000);

            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö:', error);
                updateApiStatus(false);
                showError(`–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Ä–æ–∑–∫–ª–∞–¥—ñ–≤: ${error.message}`);
                
                // –°–ø—Ä–æ–±—É—î–º–æ –∑–Ω–æ–≤—É —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(fetchScheduleData, 5000);
            }
        }

        function updateApiStatus(connected) {
            const apiStatus = document.getElementById('apiStatus');
            if (connected) {
                apiStatus.textContent = '‚úì –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ —Å–µ—Ä–≤–µ—Ä–∞';
                apiStatus.className = 'api-status connected';
            } else {
                apiStatus.textContent = '‚úó –ù–µ–º–∞—î –∑–≤\'—è–∑–∫—É –∑ —Å–µ—Ä–≤–µ—Ä–æ–º';
                apiStatus.className = 'api-status disconnected';
            }
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
        }

        function updateCurrentTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('currentTime').textContent = 
                now.toLocaleDateString('uk-UA', options);
        }

        function getFilteredSchedule() {
            // –ó–∞–≤–∂–¥–∏ —Ñ—ñ–ª—å—Ç—Ä—É—î–º–æ –∑–∞ –≤–∏–±—Ä–∞–Ω–æ—é —á–µ—Ä–≥–æ—é
            const queueNum = parseFloat(selectedQueue);
            return powerOffSchedule.filter(period => period.queue === queueNum);
        }

        function populateQueueSelector() {
            const selector = document.getElementById('queueSelector');
            const currentValue = selector.value;
            
            // –û—á–∏—â—É—î–º–æ –≤—Å—ñ options
            selector.innerHTML = '';
            
            // –î–æ–¥–∞—î–º–æ options –¥–ª—è –∫–æ–∂–Ω–æ—ó —á–µ—Ä–≥–∏
            allQueues.forEach(queue => {
                const option = document.createElement('option');
                option.value = queue;
                option.textContent = `–ß–µ—Ä–≥–∞ ${queue}`;
                selector.appendChild(option);
            });
            
            // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—é –≤–∏–±—Ä–∞–Ω—É –∑–Ω–∞—á–µ–Ω–Ω—è
            if (currentValue && allQueues.includes(parseFloat(currentValue))) {
                selector.value = currentValue;
            }
        }

        function isInOutagePeriod(checkTime) {
            const filteredSchedule = getFilteredSchedule();
            return filteredSchedule.some(period => 
                checkTime >= period.start && checkTime < period.end
            );
        }

        function getNextEvent() {
            const now = new Date();
            const isPowerOff = isInOutagePeriod(now);
            const filteredSchedule = getFilteredSchedule();

            if (isPowerOff) {
                const currentPeriods = filteredSchedule.filter(period => 
                    now >= period.start && now < period.end
                );
                if (currentPeriods.length > 0) {
                    const nextEnd = Math.max(...currentPeriods.map(p => p.end));
                    return {
                        type: 'on',
                        time: new Date(nextEnd)
                    };
                }
            } else {
                const futureOutages = filteredSchedule
                    .filter(period => period.start > now)
                    .sort((a, b) => a.start - b.start);
                
                if (futureOutages.length > 0) {
                    return {
                        type: 'off',
                        time: futureOutages[0].start
                    };
                }
            }
            return null;
        }

        function updateStatus() {
            const now = new Date();
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            const countdownLabel = document.getElementById('countdownLabel');
            const countdownTime = document.getElementById('countdownTime');

            // –Ø–∫—â–æ –Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö, –ø–æ–∫–∞–∑—É—î–º–æ —Å—ñ—Ä–∏–π —Å—Ç–∞–Ω
            if (powerOffSchedule.length === 0) {
                statusIcon.className = 'status-icon power-unknown';
                statusIcon.textContent = '‚ùì';
                statusText.textContent = '–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö';
                countdownLabel.textContent = '–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö';
                countdownTime.textContent = '--:--:--';
                return;
            }

            const isPowerOff = isInOutagePeriod(now);

            if (isPowerOff) {
                statusIcon.className = 'status-icon power-off';
                statusIcon.textContent = 'üîå';
                statusText.textContent = '–°–≤—ñ—Ç–ª–∞ –Ω–µ–º–∞—î';
                countdownLabel.textContent = '–î–æ –ø–æ—è–≤–∏ —Å–≤—ñ—Ç–ª–∞';
            } else {
                statusIcon.className = 'status-icon power-on';
                statusIcon.textContent = 'üí°';
                statusText.textContent = '–°–≤—ñ—Ç–ª–æ —î';
                countdownLabel.textContent = '–î–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è';
            }

            const nextEvent = getNextEvent();
            if (nextEvent) {
                const timeDiff = nextEvent.time - now;
                const hours = Math.floor(timeDiff / (1000 * 60 * 60));
                const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);

                countdownTime.textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            } else {
                countdownTime.textContent = '--:--:--';
            }
        }

        function getTimelineRange() {
            const now = new Date();
            const startTime = new Date(now.getTime() - 12 * 60 * 60 * 1000); // 12 –≥–æ–¥–∏–Ω –Ω–∞–∑–∞–¥
            const filteredSchedule = getFilteredSchedule();

            // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º ‚Äî 24 –≥–æ–¥–∏–Ω–∏ –≤–ø–µ—Ä–µ–¥
            let endTime = new Date(now.getTime() + 24 * 60 * 60 * 1000);

            if (filteredSchedule.length > 0) {
                // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤—Å—ñ –¥–∞—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫—ñ–≤ (–ø–æ—á–∞—Ç–æ–∫ –¥–æ–±–∏)
                const scheduleDays = filteredSchedule.map(p => {
                    const d = new Date(p.start);
                    d.setHours(0, 0, 0, 0);
                    return d.getTime();
                });
                // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –Ω–∞–π–ø—ñ–∑–Ω—ñ—à–∏–π –¥–µ–Ω—å –∑ –≥—Ä–∞—Ñ—ñ–∫–æ–º
                const maxDay = Math.max(...scheduleDays);
                // –Ø–∫—â–æ —î –≥—Ä–∞—Ñ—ñ–∫ –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –¥–µ–Ω—å –ø—ñ—Å–ª—è —Å—å–æ–≥–æ–¥–Ω—ñ—à–Ω—å–æ–≥–æ ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ timeline –¥–æ –∫—ñ–Ω—Ü—è —Ü—å–æ–≥–æ –¥–Ω—è
                const today = new Date(now);
                today.setHours(0, 0, 0, 0);
                const nextDay = new Date(today);
                nextDay.setDate(today.getDate() + 1);
                if (scheduleDays.includes(nextDay.getTime())) {
                    // –ö—ñ–Ω–µ—Ü—å –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –¥–Ω—è (00:00)
                    const endOfNextDay = new Date(nextDay);
                    endOfNextDay.setDate(endOfNextDay.getDate() + 1);
                    endOfNextDay.setHours(0, 0, 0, 0);
                    if (endOfNextDay.getTime() > endTime.getTime()) {
                        endTime = endOfNextDay;
                    }
                } else {
                    // –Ø–∫—â–æ –Ω–µ–º–∞—î –≥—Ä–∞—Ñ—ñ–∫–∞ –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –¥–µ–Ω—å ‚Äî timeline —Ç—ñ–ª—å–∫–∏ 24 –≥–æ–¥–∏–Ω–∏ –≤–ø–µ—Ä–µ–¥
                    endTime = new Date(now.getTime() + 24 * 60 * 60 * 1000);
                }
            }

            const totalHours = (endTime - startTime) / (1000 * 60 * 60);
            const totalHalfHours = Math.ceil(totalHours * 2);

            return { startTime, endTime, totalHours, totalHalfHours };
        }

        function updateTimelineSubheader() {
            const now = new Date();
            const { startTime, endTime } = getTimelineRange();
            
            const hoursBefore = Math.round((now - startTime) / (1000 * 60 * 60));
            const hoursAfter = Math.round((endTime - now) / (1000 * 60 * 60));
            
            const subheader = document.getElementById('timelineSubheader');
            subheader.textContent = `${hoursBefore} –≥–æ–¥–∏–Ω –Ω–∞–∑–∞–¥ ‚Üê –ó–ê–†–ê–ó ‚Üí ${hoursAfter} –≥–æ–¥–∏–Ω –≤–ø–µ—Ä–µ–¥`;
        }

        function initializeTimeline() {
            const now = new Date();
            const { startTime, endTime, totalHours, totalHalfHours } = getTimelineRange();
            const filteredSchedule = getFilteredSchedule();

            const timelineHours = document.getElementById('timelineHours');
            const powerOffPeriods = document.getElementById('powerOffPeriods');
            const noDataPeriods = document.getElementById('noDataPeriods');

            timelineHours.innerHTML = '';
            powerOffPeriods.innerHTML = '';
            noDataPeriods.innerHTML = '';

            for (let i = 0; i < totalHalfHours; i++) {
                const time = new Date(startTime.getTime() + i * 30 * 60 * 1000);
                const segment = document.createElement('div');
                const isHour = time.getMinutes() === 0;
                
                segment.className = isHour ? 'timeline-segment hour' : 'timeline-segment';
                segment.dataset.time = time.getTime();
                segment.dataset.hour = time.getHours();
                segment.dataset.minute = time.getMinutes();
                segment.dataset.date = time.toLocaleDateString('uk-UA', { day: 'numeric', month: 'short' });
                
                if (time < now) {
                    segment.classList.add('past');
                }
                
                const currentHourStart = new Date(now);
                currentHourStart.setMinutes(0, 0, 0);
                if (isHour && time.getTime() === currentHourStart.getTime()) {
                    segment.classList.add('current-hour');
                }

                timelineHours.appendChild(segment);
            }

            // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –¥—ñ–∞–ø–∞–∑–æ–Ω –¥–µ —î –¥–∞–Ω—ñ
            // –°—ñ—Ä—ñ –æ–±–ª–∞—Å—Ç—ñ —Ç—ñ–ª—å–∫–∏ –¥–ª—è –¥—ñ–± –±–µ–∑ –≥—Ä–∞—Ñ—ñ–∫—ñ–≤
            if (filteredSchedule.length > 0) {
                // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤—Å—ñ –¥–æ–±–∏ –∑ –≥—Ä–∞—Ñ—ñ–∫–∞–º–∏
                const scheduleDates = new Set();
                filteredSchedule.forEach(period => {
                    const dayStart = new Date(period.start);
                    dayStart.setHours(0, 0, 0, 0);
                    scheduleDates.add(dayStart.getTime());
                    
                    // –Ø–∫—â–æ –ø–µ—Ä—ñ–æ–¥ –∑–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –¥–Ω—è (–∞–ª–µ –ù–ï –æ 00:00), –¥–æ–¥–∞—î–º–æ —ñ –π–æ–≥–æ
                    const dayEnd = new Date(period.end);
                    dayEnd.setHours(0, 0, 0, 0);
                    if (dayEnd.getTime() !== dayStart.getTime() && 
                        (period.end.getHours() !== 0 || period.end.getMinutes() !== 0 || period.end.getSeconds() !== 0)) {
                        scheduleDates.add(dayEnd.getTime());
                    }
                });
                
                const sortedDates = Array.from(scheduleDates).sort((a, b) => a - b);
                const firstScheduleDay = new Date(sortedDates[0]);
                firstScheduleDay.setHours(0, 0, 0, 0);
                const lastScheduleDay = new Date(sortedDates[sortedDates.length - 1]);
                lastScheduleDay.setDate(lastScheduleDay.getDate() + 1);
                lastScheduleDay.setHours(0, 0, 0, 0);

                // –°—ñ—Ä–∞ –æ–±–ª–∞—Å—Ç—å –¥–æ –ø–µ—Ä—à–æ–≥–æ –¥–Ω—è –∑ –≥—Ä–∞—Ñ—ñ–∫–∞–º–∏
                if (startTime.getTime() < firstScheduleDay.getTime()) {
                    const div = document.createElement('div');
                    div.className = 'no-data-period';
                    
                    const duration = (Math.min(firstScheduleDay.getTime(), endTime.getTime()) - startTime.getTime()) / (1000 * 60 * 60);
                    const widthPercent = (duration / totalHours) * 100;
                    
                    div.style.left = '0%';
                    div.style.width = `${widthPercent}%`;
                    noDataPeriods.appendChild(div);
                }

                // –°—ñ—Ä–∞ –æ–±–ª–∞—Å—Ç—å –ø—ñ—Å–ª—è –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –¥–Ω—è –∑ –≥—Ä–∞—Ñ—ñ–∫–∞–º–∏
                if (endTime.getTime() > lastScheduleDay.getTime()) {
                    const div = document.createElement('div');
                    div.className = 'no-data-period';
                    
                    const startOffset = (Math.max(lastScheduleDay.getTime(), startTime.getTime()) - startTime.getTime()) / (1000 * 60 * 60);
                    const duration = (endTime.getTime() - Math.max(lastScheduleDay.getTime(), startTime.getTime())) / (1000 * 60 * 60);
                    
                    const startPercent = (startOffset / totalHours) * 100;
                    const widthPercent = (duration / totalHours) * 100;
                    
                    div.style.left = `${startPercent}%`;
                    div.style.width = `${widthPercent}%`;
                    noDataPeriods.appendChild(div);
                }
            } else {
                // –Ø–∫—â–æ –Ω–µ–º–∞—î –∂–æ–¥–Ω–∏—Ö –¥–∞–Ω–∏—Ö - –≤—Å—è timeline —Å—ñ—Ä–∞
                const div = document.createElement('div');
                div.className = 'no-data-period';
                div.style.left = '0%';
                div.style.width = '100%';
                noDataPeriods.appendChild(div);
            }

            filteredSchedule.forEach(period => {
                if (period.end > startTime && period.start < endTime) {
                    const div = document.createElement('div');
                    div.className = 'power-off-period';
                    
                    if (period.end <= now) {
                        div.classList.add('past');
                    }

                    const periodStart = Math.max(period.start, startTime);
                    const periodEnd = Math.min(period.end, endTime);

                    const startOffset = (periodStart - startTime) / (1000 * 60 * 60);
                    const duration = (periodEnd - periodStart) / (1000 * 60 * 60);

                    const startPercent = (startOffset / totalHours) * 100;
                    const widthPercent = (duration / totalHours) * 100;

                    div.style.left = `${startPercent}%`;
                    div.style.width = `${widthPercent}%`;
                    
                    // –î–æ–¥–∞—î–º–æ –¥–∞–Ω—ñ –¥–ª—è tooltip
                    div.dataset.startTime = period.start.getTime();
                    div.dataset.endTime = period.end.getTime();
                    div.dataset.queue = period.queue;
                    
                    // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π
                    div.addEventListener('mouseenter', showTooltip);
                    div.addEventListener('mouseleave', hideTooltip);
                    div.addEventListener('mousemove', moveTooltip);
                    
                    powerOffPeriods.appendChild(div);
                }
            });

            // –°—Ç–≤–æ—Ä—é—î–º–æ –∑–µ–ª–µ–Ω—ñ –±–ª–æ–∫–∏ –¥–ª—è –ø–µ—Ä—ñ–æ–¥—ñ–≤ –∑—ñ —Å–≤—ñ—Ç–ª–æ–º
            // –ì—Ä–∞—Ñ—ñ–∫–∏ –¥–æ–±–æ–≤—ñ - —è–∫—â–æ –Ω–∞ –¥–µ–Ω—å —î –≥—Ä–∞—Ñ—ñ–∫ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å, —Ç–æ –º—ñ–∂ –Ω–∏–º–∏ —î —Å–≤—ñ—Ç–ª–æ
            const powerOnPeriods = document.getElementById('powerOnPeriods');
            powerOnPeriods.innerHTML = '';
            
            if (filteredSchedule.length > 0) {
                // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤—Å—ñ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ –¥–∞—Ç–∏ –∑ –≥—Ä–∞—Ñ—ñ–∫–∞–º–∏
                const scheduleDates = new Set();
                filteredSchedule.forEach(period => {
                    const dayStart = new Date(period.start);
                    dayStart.setHours(0, 0, 0, 0);
                    scheduleDates.add(dayStart.getTime());
                    
                    // –Ø–∫—â–æ –ø–µ—Ä—ñ–æ–¥ –∑–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –¥–Ω—è (–∞–ª–µ –ù–ï –æ 00:00), –¥–æ–¥–∞—î–º–æ —ñ –π–æ–≥–æ
                    // –ü–µ—Ä—ñ–æ–¥ 22:30-00:00 –Ω–µ –¥–æ–¥–∞—î –Ω–∞—Å—Ç—É–ø–Ω—É –¥–æ–±—É, –±–æ 00:00 —Ü–µ –ø–æ—á–∞—Ç–æ–∫ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó –¥–æ–±–∏
                    const dayEnd = new Date(period.end);
                    dayEnd.setHours(0, 0, 0, 0);
                    if (dayEnd.getTime() !== dayStart.getTime() && 
                        (period.end.getHours() !== 0 || period.end.getMinutes() !== 0 || period.end.getSeconds() !== 0)) {
                        scheduleDates.add(dayEnd.getTime());
                    }
                });
                
                // –î–ª—è –∫–æ–∂–Ω–æ—ó –¥–∞—Ç–∏ –∑ –≥—Ä–∞—Ñ—ñ–∫–∞–º–∏ —Å—Ç–≤–æ—Ä—é—î–º–æ –∑–µ–ª–µ–Ω—ñ –ø–µ—Ä—ñ–æ–¥–∏
                Array.from(scheduleDates).sort((a, b) => a - b).forEach(dayTime => {
                    const dayStart = new Date(dayTime);
                    const dayEnd = new Date(dayTime);
                    dayEnd.setDate(dayEnd.getDate() + 1);
                    dayEnd.setHours(0, 0, 0, 0);
                    
                    // –û–±–º–µ–∂—É—î–º–æ –¥–æ–±—É –≤–∏–¥–∏–º–∏–º –¥—ñ–∞–ø–∞–∑–æ–Ω–æ–º timeline
                    const visibleDayStart = Math.max(dayStart.getTime(), startTime.getTime());
                    const visibleDayEnd = Math.min(dayEnd.getTime(), endTime.getTime());
                    
                    if (visibleDayStart >= visibleDayEnd) return;
                    
                    // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤—Å—ñ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–ª—è —Ü—ñ—î—ó –¥–æ–±–∏
                    const dayOffPeriods = filteredSchedule
                        .filter(p => {
                            return (p.start >= dayStart && p.start < dayEnd) ||
                                   (p.end > dayStart && p.end <= dayEnd) ||
                                   (p.start < dayStart && p.end > dayEnd);
                        })
                        .sort((a, b) => a.start - b.start);
                    
                    // –°—Ç–≤–æ—Ä—é—î–º–æ –∑–µ–ª–µ–Ω—ñ –±–ª–æ–∫–∏ –º—ñ–∂ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è–º–∏
                    let currentPosTime = visibleDayStart;
                    
                    dayOffPeriods.forEach(offPeriod => {
                        const offStartTime = Math.max(offPeriod.start.getTime(), visibleDayStart);
                        const offEndTime = Math.min(offPeriod.end.getTime(), visibleDayEnd);
                        
                        if (offStartTime > currentPosTime) {
                            // –Ñ –ø–µ—Ä—ñ–æ–¥ –∑—ñ —Å–≤—ñ—Ç–ª–æ–º –ø–µ—Ä–µ–¥ —Ü–∏–º –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è–º
                            const div = document.createElement('div');
                            div.className = 'power-on-period';
                            
                            const startOffset = (currentPosTime - startTime.getTime()) / (1000 * 60 * 60);
                            const duration = (offStartTime - currentPosTime) / (1000 * 60 * 60);
                            
                            const startPercent = (startOffset / totalHours) * 100;
                            const widthPercent = (duration / totalHours) * 100;
                            
                            div.style.left = `${startPercent}%`;
                            div.style.width = `${widthPercent}%`;
                            
                            div.dataset.startTime = currentPosTime;
                            div.dataset.endTime = offStartTime;
                            div.dataset.queue = filteredSchedule[0].queue;
                            div.dataset.powerOn = 'true';
                            
                            div.addEventListener('mouseenter', showTooltip);
                            div.addEventListener('mouseleave', hideTooltip);
                            div.addEventListener('mousemove', moveTooltip);
                            
                            powerOnPeriods.appendChild(div);
                        }
                        
                        currentPosTime = Math.max(currentPosTime, offEndTime);
                    });
                    
                    // –î–æ–¥–∞—î–º–æ –∑–µ–ª–µ–Ω–∏–π –±–ª–æ–∫ –≤—ñ–¥ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –∫—ñ–Ω—Ü—è –¥–æ–±–∏
                    if (currentPosTime < visibleDayEnd) {
                        const div = document.createElement('div');
                        div.className = 'power-on-period';
                        
                        const startOffset = (currentPosTime - startTime.getTime()) / (1000 * 60 * 60);
                        const duration = (visibleDayEnd - currentPosTime) / (1000 * 60 * 60);
                        
                        const startPercent = (startOffset / totalHours) * 100;
                        const widthPercent = (duration / totalHours) * 100;
                        
                        div.style.left = `${startPercent}%`;
                        div.style.width = `${widthPercent}%`;
                        
                        div.dataset.startTime = currentPosTime;
                        div.dataset.endTime = visibleDayEnd;
                        div.dataset.queue = filteredSchedule[0].queue;
                        div.dataset.powerOn = 'true';
                        
                        div.addEventListener('mouseenter', showTooltip);
                        div.addEventListener('mouseleave', hideTooltip);
                        div.addEventListener('mousemove', moveTooltip);
                        
                        powerOnPeriods.appendChild(div);
                    }
                });
            }

            updateTimelineLabels();
            updateTimelineSubheader();
        }

        function updateTimelineLabels() {
            const container = document.getElementById('timelineContainer');
            const labelsContainer = document.getElementById('timelineLabels');
            const allSegments = document.querySelectorAll('.timeline-segment');
            
            labelsContainer.innerHTML = '';
            
            const { totalHalfHours } = getTimelineRange();
            const containerWidth = container.offsetWidth;
            const hourSegments = [];
            allSegments.forEach((segment, index) => {
                if (index % 2 === 0) {
                    hourSegments.push({
                        segment: segment,
                        index: index
                    });
                }
            });
            
            const segmentCount = hourSegments.length;
            const segmentWidth = containerWidth / totalHalfHours;
            const minLabelDistance = 50;
            
            let step = 1;
            if (segmentWidth * 2 < minLabelDistance) step = 2;
            if (segmentWidth * 2 * 2 < minLabelDistance) step = 3;
            if (segmentWidth * 2 * 3 < minLabelDistance) step = 4;
            if (segmentWidth * 2 * 4 < minLabelDistance) step = 6;
            
            // –û—Å–Ω–æ–≤–Ω—ñ –º—ñ—Ç–∫–∏ —á–∞—Å—É (step)
            const labelPositions = new Set();
            hourSegments.forEach((item, hourIndex) => {
                const segment = item.segment;
                const segmentIndex = item.index;
                const hour = segment.dataset.hour;
                const isMidnight = hour === '0';
                if (hourIndex % step === 0 || hourIndex === 0 || hourIndex === segmentCount - 1) {
                    const label = document.createElement('div');
                    label.className = 'timeline-label show';
                    const date = segment.dataset.date;
                    const timeSpan = document.createElement('div');
                    timeSpan.className = 'label-time';
                    timeSpan.textContent = `${String(hour).padStart(2, '0')}:00`;
                    label.appendChild(timeSpan);
                    // –Ø–∫—â–æ —Ü–µ 00:00 ‚Äî –¥–æ–¥–∞—î–º–æ –¥–∞—Ç—É –ø—ñ–¥ —á–∞—Å–æ–º
                    if (isMidnight) {
                        const dateSpan = document.createElement('div');
                        dateSpan.className = 'label-date';
                        dateSpan.textContent = date;
                        label.appendChild(dateSpan);
                    }
                    const position = (segmentIndex / totalHalfHours) * 100;
                    label.style.left = `${position}%`;
                    labelsContainer.appendChild(label);
                    if (isMidnight) labelPositions.add(segmentIndex);
                }
            });
            // –î–æ–¥–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –¥–∞—Ç—É (–±–µ–∑ —á–∞—Å—É) —É –º—ñ—Å—Ü—è—Ö –ø–µ—Ä–µ—Ö–æ–¥—É –¥–æ–±–∏, —è–∫—â–æ –Ω–µ–º–∞—î –º—ñ—Ç–∫–∏ —á–∞—Å—É 00:00
            hourSegments.forEach((item, hourIndex) => {
                const segment = item.segment;
                const segmentIndex = item.index;
                const hour = segment.dataset.hour;
                const isMidnight = hour === '0';
                if (isMidnight && !labelPositions.has(segmentIndex)) {
                    const label = document.createElement('div');
                    label.className = 'timeline-label show';
                    // –î–æ–¥–∞—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ–π label-time –¥–ª—è –≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è
                    const timeSpan = document.createElement('div');
                    timeSpan.className = 'label-time';
                    timeSpan.innerHTML = '&nbsp;';
                    label.appendChild(timeSpan);
                    const date = segment.dataset.date;
                    const dateSpan = document.createElement('div');
                    dateSpan.className = 'label-date';
                    dateSpan.textContent = date;
                    label.appendChild(dateSpan);
                    const position = (segmentIndex / totalHalfHours) * 100;
                    label.style.left = `${position}%`;
                    labelsContainer.appendChild(label);
                }
            });
        }

        function showTooltip(event) {
            const tooltip = document.getElementById('timelineTooltip');
            const tooltipTime = document.getElementById('tooltipTime');
            const tooltipDuration = document.getElementById('tooltipDuration');
            
            const startTime = new Date(parseInt(event.target.dataset.startTime));
            const endTime = new Date(parseInt(event.target.dataset.endTime));
            const queue = event.target.dataset.queue;
            const isPowerOn = event.target.dataset.powerOn === 'true';
            
            const duration = (endTime - startTime) / (1000 * 60 * 60);
            let hours = Math.floor(duration);
            let minutes = Math.round((duration - hours) * 60);
            if (minutes === 60) { hours++; minutes = 0; }
            
            // –§–æ—Ä–º–∞—Ç –¥–∞—Ç–∏: 17 –ª—é—Ç.
            const dateStr = startTime.toLocaleDateString('uk-UA', { day: 'numeric', month: 'short' });
            tooltipTime.textContent = `${dateStr} ${startTime.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' })} - ${endTime.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' })}`;
            
            let durationText = '';
            if (hours > 0) {
                durationText = `${hours} –≥–æ–¥`;
                if (minutes > 0) durationText += ` ${minutes} —Ö–≤`;
            } else {
                durationText = `${minutes} —Ö–≤`;
            }
            
            const statusText = isPowerOn ? 'üí° –°–≤—ñ—Ç–ª–æ —î' : 'üîå –í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è';
            tooltipDuration.textContent = `–ß–µ—Ä–≥–∞ ${queue} ‚Ä¢ ${statusText} ‚Ä¢ ${durationText}`;
            
            tooltip.classList.add('show');
            moveTooltip(event);
        }

        function hideTooltip() {
            const tooltip = document.getElementById('timelineTooltip');
            tooltip.classList.remove('show');
        }

        function moveTooltip(event) {
            const tooltip = document.getElementById('timelineTooltip');
            
            // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ fixed positioning –≤—ñ–¥–Ω–æ—Å–Ω–æ viewport
            let left = event.clientX;
            let top = event.clientY - tooltip.offsetHeight - 10;
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —â–æ–± tooltip –Ω–µ –≤–∏—Ö–æ–¥–∏–≤ –∑–∞ –º–µ–∂—ñ –µ–∫—Ä–∞–Ω—É
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            if (left + tooltip.offsetWidth > viewportWidth - 10) {
                left = viewportWidth - tooltip.offsetWidth - 10;
            }
            if (left < 10) {
                left = 10;
            }
            if (top < 10) {
                top = event.clientY + 10;
            }
            
            tooltip.style.left = `${left}px`;
            tooltip.style.top = `${top}px`;
        }

        function updateTimeMarker() {
            const now = new Date();
            const { startTime, totalHours } = getTimelineRange();
            const offset = (now - startTime) / (1000 * 60 * 60);
            
            const marker = document.getElementById('timeMarker');
            const offsetPercent = (offset / totalHours) * 100;
            marker.style.left = `${offsetPercent}%`;
        }

        function initializeScheduleList() {
            const scheduleList = document.getElementById('scheduleList');
            const now = new Date();
            const filteredSchedule = getFilteredSchedule();
            const { startTime, endTime } = getTimelineRange();

            const past = [];
            const current = [];
            const upcoming = [];

            filteredSchedule.forEach(period => {
                const isPast = period.end <= now;
                const isCurrent = now >= period.start && now < period.end;

                if (period.start >= startTime && period.start <= endTime) {
                    if (isPast) {
                        past.push(period);
                    } else if (isCurrent) {
                        current.push(period);
                    } else {
                        upcoming.push(period);
                    }
                }
            });

            function createScheduleItem(period, isActive = false, isPast = false) {
                const item = document.createElement('div');
                item.className = 'schedule-item';
                if (isActive) item.classList.add('active');
                if (isPast) item.classList.add('past');

                const leftDiv = document.createElement('div');
                leftDiv.className = 'schedule-item-left';
                
                const queueDiv = document.createElement('div');
                queueDiv.className = 'schedule-queue';
                queueDiv.textContent = `–ß–µ—Ä–≥–∞ ${period.queue}`;
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'schedule-time';
                timeDiv.textContent = `${period.start.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' })} - ${period.end.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' })} | ${period.start.toLocaleDateString('uk-UA', { day: 'numeric', month: 'short' })}`;

                leftDiv.appendChild(queueDiv);
                leftDiv.appendChild(timeDiv);

                const statusSpan = document.createElement('span');
                statusSpan.className = 'schedule-status off';
                statusSpan.textContent = isActive ? '–ó–∞—Ä–∞–∑' : (isPast ? '–ú–∏–Ω—É–ª–æ' : '–í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è');

                item.appendChild(leftDiv);
                item.appendChild(statusSpan);
                return item;
            }

            scheduleList.innerHTML = '';

            if (current.length > 0) {
                const section = document.createElement('div');
                section.className = 'schedule-section';
                const title = document.createElement('div');
                title.className = 'schedule-section-title';
                title.textContent = 'üî¥ –ó–∞—Ä–∞–∑ –Ω–µ–º–∞—î —Å–≤—ñ—Ç–ª–∞';
                section.appendChild(title);
                current.forEach(period => {
                    section.appendChild(createScheduleItem(period, true));
                });
                scheduleList.appendChild(section);
            }

            if (upcoming.length > 0) {
                const section = document.createElement('div');
                section.className = 'schedule-section';
                const title = document.createElement('div');
                title.className = 'schedule-section-title';
                title.textContent = 'üìÖ –ù–∞—Å—Ç—É–ø–Ω—ñ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è';
                section.appendChild(title);
                upcoming.slice(0, 10).forEach(period => {
                    section.appendChild(createScheduleItem(period));
                });
                scheduleList.appendChild(section);
            }

            if (current.length === 0 && upcoming.length === 0) {
                const noData = document.createElement('div');
                noData.className = 'no-data';
                noData.textContent = '–ù–∞ –¥–∞–Ω–∏–π –º–æ–º–µ–Ω—Ç –Ω–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö —Ä–æ–∑–∫–ª–∞–¥—ñ–≤';
                scheduleList.appendChild(noData);
            }
        }

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ä–æ–∑–º—ñ—Ä—É –≤—ñ–∫–Ω–∞
        window.addEventListener('resize', () => {
            updateTimelineLabels();
        });

        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        (async () => {
            const needsSetup = await checkSetupRequired();
            if (!needsSetup) {
                fetchScheduleData();
                // –û–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ –∫–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥
                setInterval(fetchScheduleData, 30000);
            }
        })();
    </script>
</body>
</html>
